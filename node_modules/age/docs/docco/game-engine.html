<!DOCTYPE html>

<html>
<head>
  <title>game-engine.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="achievement-rule.html">
                achievement-rule.coffee
              </a>
            
              
              <a class="source" href="data-store.html">
                data-store.coffee
              </a>
            
              
              <a class="source" href="game-engine.html">
                game-engine.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="memory-data-store.html">
                memory-data-store.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>game-engine.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>The <strong>GameEngine</strong> fulfills two primary roles:</p>
<ol>
<li><p>It offers a centralized API that used by internal and external
clients to inspect or act on the current game state.</p>
</li>
<li><p>It implements the logic that drives the game itself--evaluating
whether achievements have been achieved, etc.</p>
</li>
</ol>
<p>The GameEngine is an <code>EventEmitter</code>, emitting events when an
event has occured or an achievement has been achieved.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>path            = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
fs              = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
HOMEDIR         = path.join(__dirname,<span class="hljs-string">'..'</span>)
IS_INSTRUMENTED = fs.existsSync(path.join(HOMEDIR,<span class="hljs-string">'lib-cov'</span>))
LIB_DIR         = <span class="hljs-keyword">if</span> IS_INSTRUMENTED <span class="hljs-keyword">then</span> path.join(HOMEDIR,<span class="hljs-string">'lib-cov'</span>) <span class="hljs-keyword">else</span> path.join(HOMEDIR,<span class="hljs-string">'lib'</span>)
MemoryDataStore = <span class="hljs-built_in">require</span>(path.join(LIB_DIR,<span class="hljs-string">'memory-data-store'</span>)).MemoryDataStore
Util            = <span class="hljs-built_in">require</span>(path.join(LIB_DIR,<span class="hljs-string">'util'</span>)).Util
EventEmitter    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GameEngine</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><code>GameEngine.EET_ACHIEVED</code> is the EventEmitter event type used
when a player has earned an achievement.  The corresponding
EventEmitter event object will contain four properities:</p>
<ol>
<li><code>player</code> -- the player that earned this achievement</li>
<li><code>achievement</code>-- the achievement that was earned</li>
<li><code>engine</code> -- this GameEngine instance</li>
<li><code>type</code> -- a string <code>GameEngine.EET_ACHIEVED</code></li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@EET_ACHIEVED</span>: <span class="hljs-string">'achievement-achieved'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><code>GameEngine.EET_OCCURRED</code> is the EventEmitter event type used
when an event has occurred.  The corresponding EventEmitter
event object will contain four properities:</p>
<ol>
<li><code>player</code> -- the player to which to the event occurred</li>
<li><code>event</code>-- the event</li>
<li><code>engine</code> -- this GameEngine instance</li>
<li><code>type</code> -- a string <code>GameEngine.EET_OCCURRED</code></li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@EET_OCCURRED</span>: <span class="hljs-string">'event-occurred'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>The GameEngine constructor accepts two optional
arguments: a DataStore instance and an array of
achievement rules.</p>
<p>The first defaults to <code>MemoryDataStore</code>, the
second to an empty array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">constructor</span>:<span class="hljs-function"><span class="hljs-params">(datastore,achievement_rules)</span>-&gt;</span>
    <span class="hljs-property">@datastore</span> = datastore ? <span class="hljs-keyword">new</span> MemoryDataStore()
    <span class="hljs-property">@achievement_rules</span> = achievement_rules ? []</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><code>add_player</code> ensures that a player object exists
for the given <code>player</code>.  (The <code>player</code> MUST have
an <code>id</code> property.)</p>
<p>The <code>callback</code> function should accept one argument,
an error object (that will be <code>null</code> when no error
occurred and the player was succesfully added).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">add_player</span>:<span class="hljs-function"><span class="hljs-params">(player,callback)</span>=&gt;</span>
    <span class="hljs-property">@datastore</span>.record_player(player,callback)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><code>add_event</code> reports that the given <code>event</code> occurred
for the given <code>player</code>.</p>
<p>The <code>callback</code> function should accept one argument,
an error object (that will be <code>null</code> when no error
occurred and the event was succesfully recorded).</p>
<p>This method will emit a <code>GameEngine.EET_OCCURRED</code>
message to any registered listeners.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">add_event</span>:<span class="hljs-function"><span class="hljs-params">(player,event,callback)</span>=&gt;</span>
    <span class="hljs-property">@datastore</span>.record_event player, event, <span class="hljs-function"><span class="hljs-params">(err)</span>=&gt;</span>
      <span class="hljs-keyword">if</span> err?
        callback?(err)
      <span class="hljs-keyword">else</span>
        <span class="hljs-property">@emit</span>(GameEngine.EET_OCCURRED, {<span class="hljs-attribute">player</span>:player,<span class="hljs-attribute">event</span>:event,<span class="hljs-attribute">engine</span>:<span class="hljs-keyword">this</span>,<span class="hljs-attribute">type</span>:GameEngine.EET_OCCURRED})
        callback?()</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><code>add_event</code> reports that the given <code>player</code> earned
for specified <code>achievement</code>.</p>
<p>The <code>callback</code> function should accept one argument,
an error object (that will be <code>null</code> when no error
occurred and the achievement was succesfully recorded).</p>
<p>This method will emit a <code>GameEngine.EET_ACHIEVED</code>
message to any registered listeners.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">add_achievement</span>:<span class="hljs-function"><span class="hljs-params">(player,achievement,callback)</span>=&gt;</span>
    <span class="hljs-property">@datastore</span>.record_achievement player,achievement, <span class="hljs-function"><span class="hljs-params">(err)</span>=&gt;</span>
      <span class="hljs-keyword">if</span> err?
        callback?(err)
      <span class="hljs-keyword">else</span>
        <span class="hljs-property">@emit</span>(GameEngine.EET_ACHIEVED, {<span class="hljs-attribute">player</span>:player,<span class="hljs-attribute">achievement</span>:achievement,<span class="hljs-attribute">engine</span>:<span class="hljs-keyword">this</span>,<span class="hljs-attribute">type</span>:GameEngine.EET_ACHIEVED})
        callback?()</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><code>add_achievement_rule</code> registers a new achievement
rule with the GameEngine.  Subsequent invocations of
<code>get_player_achievements</code> will evaluate the given
achievement rule.</p>
<p>See the <code>AchievementRule</code> type for more details.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">add_achievement_rule</span>:<span class="hljs-function"><span class="hljs-params">(rule)</span>=&gt;</span>
    <span class="hljs-property">@achievement_rules</span>.push rule</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><code>get_player</code> will fetch the player object specified by
<code>player.id</code>.  The <code>callback</code> function should accept
two arguments: an error object (which will be <code>null</code>
when no error occurred) and the fetched player object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">get_player</span>:<span class="hljs-function"><span class="hljs-params">(player,callback)</span>=&gt;</span>
    <span class="hljs-property">@datastore</span>.get_player(player,callback)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><code>get_player_history</code> will fetch the event history for the player
specified by <code>player.id</code>.  The <code>callback</code> function should
accept two arguments: an error object (which will be <code>null</code>
when no error occurred) and an array of events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">get_player_history</span>:<span class="hljs-function"><span class="hljs-params">(player,callback)</span>=&gt;</span>
    <span class="hljs-property">@get_player</span> player, <span class="hljs-function"><span class="hljs-params">(err,player)</span>=&gt;</span>
      callback?(err,player?.history ? [])</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><code>get_player_achievements</code> will fetch the achievements for the player
specified by <code>player.id</code>.  The <code>callback</code> function should
accept two arguments: an error object (which will be <code>null</code>
when no error occurred) and an array of achievements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">get_player_achievements</span>:<span class="hljs-function"><span class="hljs-params">(player,callback)</span>=&gt;</span>
    <span class="hljs-property">@get_player</span> player, <span class="hljs-function"><span class="hljs-params">(err,player)</span>=&gt;</span>
      <span class="hljs-function"><span class="hljs-title">action</span> = <span class="hljs-params">(rule,index,list,next)</span>=&gt;</span>
        <span class="hljs-property">@_evaluate_achievement_rule</span> player,rule,<span class="hljs-function"><span class="hljs-params">(err)</span>=&gt;</span>
          <span class="hljs-keyword">if</span> err?
            callback?(err,player?.achievements)
          <span class="hljs-keyword">else</span>
            next()
      Util.for_each_async <span class="hljs-property">@achievement_rules</span>, action, <span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>
        callback?(<span class="hljs-literal">null</span>,player?.achievements)

  <span class="hljs-attribute">_evaluate_single_achievement</span>:<span class="hljs-function"><span class="hljs-params">(key,player,rule,callback)</span>=&gt;</span>
    <span class="hljs-keyword">if</span> rule.multiplicity? <span class="hljs-keyword">and</span> rule.multiplicity &gt; <span class="hljs-number">0</span>
      count = Util.count(player.achievements,key,rule.multiplicity)
      <span class="hljs-keyword">if</span> count &gt;= rule.multiplicity
        callback?()
        <span class="hljs-keyword">return</span>
    rule.predicate key, <span class="hljs-keyword">this</span>, player, <span class="hljs-function"><span class="hljs-params">(err,achieved)</span>=&gt;</span>
      <span class="hljs-keyword">if</span> err?
        callback?(err)
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> achieved
        player.achievements.push(key)
        <span class="hljs-keyword">if</span> rule.transient? <span class="hljs-keyword">and</span> rule.transient
          callback?()
        <span class="hljs-keyword">else</span>
          <span class="hljs-property">@add_achievement</span>(player,key,callback)
      <span class="hljs-keyword">else</span>
        callback?()</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><code>_evaluate_achievement_rule</code> is a private utility method.
This method will evaluate the given <code>rule</code> for the given
<code>player</code>, make the requisite changes to the game state
and then invoke the <code>callback</code> method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">_evaluate_achievement_rule</span>:<span class="hljs-function"><span class="hljs-params">(player,rule,callback)</span>=&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> rule.key <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
      keyfn = rule.key
    <span class="hljs-keyword">else</span>
      <span class="hljs-function"><span class="hljs-title">keyfn</span> = <span class="hljs-params">(e,p,c)</span>-&gt;</span>c(<span class="hljs-literal">null</span>,rule.key)
    keyfn <span class="hljs-keyword">this</span>, player, <span class="hljs-function"><span class="hljs-params">(err,keys)</span>=&gt;</span>
      <span class="hljs-keyword">if</span> err?
        callback?(err)
        <span class="hljs-keyword">return</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">unless</span> keys?
        callback?()
        <span class="hljs-keyword">return</span>
      <span class="hljs-keyword">else</span>
        keys = [ keys ] <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> (Array.isArray(keys)))
        <span class="hljs-function"><span class="hljs-title">for_each</span> = <span class="hljs-params">(key,index,list,next)</span>=&gt;</span>
          <span class="hljs-property">@_evaluate_single_achievement</span> key, player, rule, <span class="hljs-function"><span class="hljs-params">(err)</span>=&gt;</span>
            <span class="hljs-keyword">if</span> err?
              callback?(err)
            <span class="hljs-keyword">else</span>
              next()
        Util.for_each_async(keys,for_each,callback)</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>(not a guaranteed part of the GameEngine interface)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">achievements_by_player</span>:<span class="hljs-function"><span class="hljs-params">(callback)</span>=&gt;</span>
    <span class="hljs-keyword">unless</span> <span class="hljs-property">@datastore</span>.enumerate_player_ids?
      callback?(<span class="hljs-keyword">new</span> Error(<span class="hljs-string">"Method not supported"</span>))
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@datastore</span>.enumerate_player_ids <span class="hljs-function"><span class="hljs-params">(err,players)</span>=&gt;</span>
        map = {}
        <span class="hljs-function"><span class="hljs-title">for_each</span> = <span class="hljs-params">(id,index,list,next)</span>=&gt;</span>
          <span class="hljs-property">@get_player_achievements</span> {<span class="hljs-attribute">id</span>:id}, <span class="hljs-function"><span class="hljs-params">(err,achievements)</span>=&gt;</span>
            <span class="hljs-keyword">if</span> err?
              callback?(err)
            <span class="hljs-keyword">else</span>
              map[id] = achievements
              next()
        <span class="hljs-function"><span class="hljs-title">when_done</span> = <span class="hljs-params">()</span>=&gt;</span>callback?(<span class="hljs-literal">null</span>,map)
        Util.for_each_async(players,for_each,when_done)</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>The GameEngine is exported under the name <code>GameEngine</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">exports</span> = <span class="hljs-built_in">exports</span> ? <span class="hljs-keyword">this</span>
<span class="hljs-built_in">exports</span>.GameEngine = GameEngine</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
